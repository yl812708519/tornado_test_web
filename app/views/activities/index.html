{% extends "../layouts/application.html" %}
{% block left %}
{% end %}
{% block body %}
<div class="container" style="margin-top:17px;">
		<div>
			<div class="col-md-10">
                {% if len(will)!=0 and will != None %}
				<div class="activities_new_active" >最新活动</div>
                {%end%}
                    {% for activity in will%}
                          <div class="activities_new_actives">
                            <div class="col-md-3 hidden-xs" style="overflow:hidden;padding-left:0px;">
                                <img src="{{activity.thumb}}" style="width: 175px;height: 215px;">
                            </div>
                            <div class="col-md-9 col-xs-12">
                                <div class="activities_new_blod"><a href="/activity/{{activity.id}}" style="color:#09386e;font-size:20px;"><span style="margin-right:5px;">[{{activity.city}}]</span>{{activity.title}}</a></div>
                                <div class="" style="margin-top:9px;line-height:24px;"><span class="activities_new_blod" style="font-size:16px;">简介：</span>{{activity.summary}}</div>
                                <div class="" style="margin-top:6px;"><span style="font-size: 16px;"  class="activities_new_blod">时间：</span>{{activity.meeting_date}}<span class="activities_new_blod" style="margin-left:12%; font-size: 16px;">人数：</span>{{activity.participants_count}}</div>
                                <div class="" style="margin-top:6px;"><span class="activities_new_blod" style="font-size: 15px;">地点：</span>{{activity.address}}</div>
                                <button data-toggle="modal" data-target="#myModal_{{activity.id}}" class="btn btn-primary btn-xs" style="width:60px;height:32px;font-size:15px; margin-top:13px;">报名</button>
                                <div class="modal fade myModal" id="myModal_{{activity.id}}">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                                <h4 class="modal-title">个人信息</h4>
                                            </div>
                                                <div class="modal-body">
                                                    <!--开始-->
                                                    <form id="registrationForm" method="post" class="form-horizontal" onsubmit="return false;">
                                                        {% raw xsrf_form_html()%}
                                                        <div class="form-group">
                                                            <label class="col-sm-3 control-label">姓名</label>
                                                            <div class="col-sm-5">
                                                                <input type="text" class="form-control" name="username" id="name{{activity.id}}"/>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label class="col-sm-3 control-label">邮箱</label>
                                                            <div class="col-sm-5">
                                                                <input type="text" class="form-control" name="email" id="email{{activity.id}}"/>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label class="col-sm-3 control-label">参会人数</label>
                                                            <div class="col-sm-5">
                                                                <input type="text" class="form-control" name="renshu" id="participants_count{{activity.id}}"/>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label class="col-sm-3 control-label">联系方式</label>
                                                            <div class="col-sm-5">
                                                                <input type="text" class="form-control" name="phone" id="mobile{{activity.id}}"/>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label class="col-sm-3 col-xs-3 control-label">地址</label>
                                                            <div class="col-md-4 col-xs-4" style="padding-right:0px;">
                                                                 <select class="form-control" id="provinces">
				                                                 </select>
                                                            </div>
                                                            <div class="col-md-4 col-xs-4" style="padding-right:0px;">
                                                                 <select class="form-control" id="cities">
				                                                 </select>
                                                            </div>
                                                            <div class="col-md-1">
                                                            </div>
                                                        </div>
                                                        <div style="display:none">
                                                            <input type="hidden" name="participant.activity" value="{{activity.title}}" id="activity_title{{activity.id}}">
                                                            <input type="hidden" class="province" name="participant.province" value="110000" id="ycyprovince{{activity.id}}">
                                                            <input type="hidden" class="city" name="participant.city" value="110100" id="ycycity{{activity.id}}">
                                                        </div>
                                                        <div class="form-group">
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                                                <input type="submit" name="activities" data="{{activity.id}}" class="btn btn-primary btn-default" value="保存" id="activities"/>
                                                            </div>
                                                        </div>
                                                    </form>
                                                    <div class="clear"></div>
                                                    <!--结束-->
                                                </div>

                                        </div><!-- /.modal-content -->
                                    </div><!-- /.modal-dialog -->
                                    </div><!-- /.modal -->
                            </div>
                            <div><img src="/s/img/xuxiantiao.png" class="activities_xuxiantiao"></div>
                            </div>
                    {% end %}
                {% if len(done)!=0 and done != None %}
				<div class="activities_old_active" style="margin-top:20px">过期活动</div>
				<div class="activities_old_actives" style="margin-top:53px">
                    {% for activity in done %}
                        <div class="col-md-3 activities_lod_time " >{{activity.meeting_date}}</div>
                        <div class="col-md-9" style="margin-bottom: 20px">
                            <div><a  class="activities_old_title" href="/activity/{{activity.id}}" target="_blank"><span style="margin-right:5px;">[{{activity.city}}]</span>{{activity.title}}</a></div>
                            <div class="activities_old_content">{{activity.summary}}</div>
                        </div>
                        <div style="margin-bottom:20px"><img src="/s/img/xuxiantiao.png" class="activities_xuxiantiao"></div>
                    {% end %}
				</div>
                <!--分页html代码开始-->
                <div class="wtable-footer col-md-12" style="text-align:center">
                    <div id="pagination-container" style="margin-bottom:35px;text-align: center;"></div>
                </div>{%end%}
                <!--分页html代码结婚-->
       </div>
        <div class="col-md-2 hidden-xs">
               <img  src="/s/img/erweima.png" />
               <div class="News_information_word new_erweima">微信公众平台:搜索"易正达"或扫描下面的二维码</div>
        </div>
        <div class="col-xs-12 visible-xs" style="text-align: center;margin:0 auto;">
                <div><img src="/s/img/erweima.png" style="margin-top: 20px" /></div>
                <div class="News_information_word new_erweima_visible" >微信公众平台:搜索"易正达"或扫描下面的二维码</div>
        </div>
</div>
</div>
{% end %}
{% block javascript %}
<script src="/s/js/provinces.js"></script>
<script src="/s/js/cities.js"></script>
<script type="text/javascript" src="{{static_url('js/w-page.min.js')}}"></script><!--分页-->
<script>
/*分页开始*/
var content={{done_count}};
var pages=Math.ceil(content/10);
var d_page={{current_page}};
 $(function () {
        $('#pagination-container').wPage({
            currentPage:d_page,    // 当前页 默认 1
            totalPage:pages,     // 总页数 默认 1
            firstCount: 1,      // 1 ... 3 4 5 ... 108首页处预览页数 默认 1
            lastCount: 1,       // 1 ... 3 4 5 ... 108尾页处预览页数 默认 1
            prevCount: 2,       // 当前页前预览页数 默认 2
            nextCount: 6,       // 当前页后预览页数 默认 6
            clickCallBack:function (pageNum, $element){
                 window.location.href='/activities?page='+pageNum;
            }
        });
        var currentPage = $('#pagination-container').wPage("getCurrentPage");
        var totalPage = $('#pagination-container').wPage("getTotalPage");
//        console.log(currentPage+'/'+totalPage);
    });
/*分页结束*/
//二级城市联动开始
function find(num,arr2){
			var arrs=[];
				for(var i=0;i<arr2.length;i++){
					    if(arr2[i][2]==num){
							arrs.push(arr2[i]);
						}
					}
			return arrs;
}
var oprovinces = document.getElementById('provinces');
var ocities = document.getElementById('cities');
for (var i = 0; i < provinces.length; i++) {
    $('#provinces').append('<option value=' + provinces[i][0] + '>' + provinces[i][1] + '</option>');
}
;
ocitie = find(110000, cities);
for (var i = 0; i < ocitie.length; i++) {
    $('#cities').append('<option value=' + ocitie[i][0] + '>' + ocitie[i][1] + '</option>');
};
try {
    oprovinces.onchange = function () {
        if (this.value) {
            $('.city').css('display', 'block');
            $('#cities').html('');
            ocitie = find(this.value, cities);
            for (var i = 0; i < ocitie.length; i++) {
                $('#cities').append('<option value=' + ocitie[i][0] + '>' + ocitie[i][1] + '</option>');
            };
        }
        $('.province').attr('value', this.value);
        $('.city').attr('value', ocities.value);
    }
    ocities.onchange = function () {
        $('.city').attr('value', this.value);
    }
}catch(e){
    console.log(e);
}

//二级城市联动结束
//校验开始
$(document).ready(function() {
    $('#registrationForm').bootstrapValidator({
        // To use feedback icons, ensure that you use Bootstrap v3.1.0 or later
        feedbackIcons: {
            valid: 'glyphicon glyphicon-ok',
            invalid: 'glyphicon glyphicon-remove',
            validating: 'glyphicon glyphicon-refresh'
        },
        fields: {
            username: {
                message: 'The username is not valid',
                validators: {
                    notEmpty: {
                        message: '姓名是必需的，不能是空的'
                    },
                    stringLength: {
                        min: 2,
                        max: 30,
                        message: '姓名必须大于2且小于30个字'
                    },
                    regexp: {
                        regexp: /^[a-zA-Z\u4E00-\u9FA5]+$/,
                        message: '姓名只能是文字和字母'
                    },
                    different: {
                        field: 'password',
                        message: 'The username and password cannot be the same as each other'
                    }
                }
            },
            email: {
                validators: {
                    notEmpty: {
                        message: '电子邮件地址不是有效的'
                    },
                    emailAddress: {
                        message: '电子邮件地址不是有效的'
                    }
                }
            },
            grop: {
                validators: {
                    notEmpty: {
                        message: '请选择'
                    },
                }
            },
            renshu: {
                message: '人数不能为空',
                validators: {
                    notEmpty: {
                        message: '人数不能为空'
                    },
                    regexp: {
                        regexp: /^[0-9]+$/,
                        message: '只能写数字'
                    },
                }
            },
            phone: {
                message: '请仔细检查你的电话号码',
                validators: {
                    notEmpty: {
                        message: '手机号码不能为空'
                    },
                    regexp: {
                        regexp: /(\d{11})|^((\d{7,8})|(\d{4}|\d{3})-(\d{7,8})|(\d{4}|\d{3})-(\d{7,8})-(\d{4}|\d{3}|\d{2}|\d{1})|(\d{7,8})-(\d{4}|\d{3}|\d{2}|\d{1}))$/,
                        message: '请仔细检查你的电话号码'
                    },
                }
            },
            gender: {
                validators: {
                    notEmpty: {
                        message: '请仔细填写资料'
                    }
                }
            }

        }
    });
});
//校验结束
//ajax请求开始
$("input[name=activities]").click(function(){
if($('#registrationForm').data('bootstrapValidator').isValid()){
aid = $(this).attr('data')
       $.ajax({
             type: "POST",
             url: "/activity/"+aid,
             data:{'participant.name':$("#name"+aid).val(),'participant.email':$("#email"+aid).val(),'participant.participants_count':$("#participants_count"+aid).val(),'participant.mobile':$("#mobile"+aid).val(),'participant.province':$(".province").val(),'participant.city':$(".city").val(),'participant.activity_title':$("#activity_title"+aid).val(),'_xsrf':$("input[name=_xsrf]").val()},
             dataType: "json",
             success:function(data){
                 if(data.type==1){
                     $('.myModal').modal('hide')
                     wModalDialog({
                          content:('报名成功'),
                          showAnimate:true,
                          type:"success"
                     });
                 }else{
                     $('.myModal').modal('hide')
                     wModalDialog({
                        content:('报名失败'),
                        showAnimate:true,
                        type:"failed"
                     });
                 }
             },
             error:function(data){
               $('.myModal').modal('hide')
                     wModalDialog({
                        content:('报名失败'),
                        showAnimate:true,
                        type:"failed"
                     });
                }
         });
    };
});
//ajax请求结束
</script>
{% end %}
