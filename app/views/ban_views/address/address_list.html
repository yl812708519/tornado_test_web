{% extends "../layouts/application.html" %}
{% block body %}
<div class="patent_application">
    <div class="container right-content">
        <div class="row">
            {% include "../layouts/left.html"%}
            <div class="col-sm-10 top">
                <div class="col-md-12 col-xs-12 col-sm-12">
                    <div class="color"></div>
                    <div class="content_title">发票地址管理</div>
                    <br style="clear:both;">
                </div>
                <div class="invoices col-sm-12">
                    <div class="f-title-1" style="margin-bottom: 30px;">
                        <button class="f-address-add btn-red" data-toggle="modal" data-target="#myModal"> + 使用新地址：</button>
                        <span class="y-pale">(最多保存5个地址)</span>
                    </div>
                    <form action="/invoice" class="form-horizontal" role="form" method="post" style="padding-left: 15px;">
                        <div class="form-group ">
                            <table class="table table-striped table-bordered table-hover" style="border:none;">
                                <thead>
                                <tr style="background-color: #e7e7e7">
                                    <th style="width:60px;border:none" class="th_sty"></th>
                                    <th class="th_sty" style="border:none;">收件人姓名</th>
                                    <th class="th_sty" style="border:none;">电话号码</th>
                                    <th class="th_sty" style="border:none;">邮编</th>
                                    <th class="th_sty" style="border:none;">地址</th>
                                    <th class="th_sty" style="border:none;">操作</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for address in delivery_addresses %}
                                <tr class="th_sty">
                                    <td style="border:none;"></td>
                                    <td class="algin_sty" style="border:none;">{{address.name}}</td>
                                    <td class="algin_sty" style="border:none;">{{address.mobile}}</td>
                                    <td class="algin_sty" style="border:none;">{{address.postalcode}}</td>
                                    <td class="algin_sty" style="border:none;">{{address.address}}</td>
                                    <td class="algin_sty" style="border:none;">
                                        <a href="#" data-toggle="modal" class="xiaoshou delivery_address_modify txt_btn"
                                           data-target="#myModal1" data-value="{{address.id}}"
                                           style="text-align:right;padding: 0 15px; margin-top:-30px;color: #096f19;text-decoration:none;outline: none;">编辑</a>
                                        <a href="#" name="delete" data-repayment="{{address.id}}"
                                           class="delivery_address_delete"
                                           style="color: #096f19;text-decoration:none">删除</a>
                                    </td>
                                </tr>
                                {% end %}
                                </tbody>
                            </table>
                        </div>
                    </form>
                    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
                         aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3>使用新地址</h3>
                                </div>
                                <div class="modal-body">
                                    <form action="/delivery_address" method="post" class="form-horizontal delivery_form">
                                        {% raw xsrf_form_html() %}
                                        <div class="form-group">
                                            <label class="control-label col-sm-3">收件人姓名：</label>

                                            <div class="col-sm-9">
                                                <input class="form-control" type="text" id="add_name"
                                                       name="add_delivery_address.name">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">所在地区</label>
                                            <div class="col-sm-3 col-xs-12">
                                                <select class="form-control"  id="provinces" name="provinces"></select>
                                            </div>
                                            <div class="col-sm-3 col-xs-12">
                                                 <select class="form-control" id="cities" name="cities"></select>
                                            </div>
                                            <div class="col-sm-3 col-xs-12">
                                                <select class="form-control" id="areas" name="areas"></select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-sm-3">街道地址：</label>

                                            <div class="col-sm-9">
                                                <input class="form-control" type="text" id="add_address"
                                                       name="add_delivery_address.address">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-sm-3">邮政编码：</label>

                                            <div class="col-sm-9">
                                                <input class="form-control" type="text">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-sm-3">手机号码：</label>

                                            <div class="col-sm-9">
                                                <input class="form-control" type="text" id="add_mobile"
                                                       name="add_delivery_address.mobile">
                                            </div>
                                        </div>
                                        <div style="display:none">
                                            <input type="hidden" class="province" name="delivery_address.province_code" value="{{add_delivery_address.get('province_code',110000)}}" id="ycyprovince">
                                            <input type="hidden" class="city" name="delivery_address.city_code" value="{{add_delivery_address.get('city_code',110100)}}" id="ycycity">
                                            <input type="hidden" class="ycyqb" name="delivery_address.area_code" value="{{add_delivery_address.get('area_code',110101)}}" id="ycyareas">
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" id="submit_apply">确认</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
                         aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                                            class="sr-only">Close</span></button>
                                    <h3>修改地址</h3>
                                </div>
                                <div class="modal-body">
                                    <form action="/delivery_address" method="post" class="form-horizontal change_address"
                                          id="form_a">
                                        {% raw xsrf_form_html() %}
                                        <input name="_method" type="hidden" value="put" />
                                        <input id="change_delivery_address_id" name="change_delivery_address.id" type="hidden" value="{{change_delivery_address.id}}" />
                                        <div class="form-group">
                                            <label class="control-label col-sm-3">收件人姓名：</label>

                                            <div class="col-sm-9">
                                                <input class="form-control" type="text" name="change_delivery_address.name"
                                                       value="{{change_delivery_address.name}}">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">所在地区</label>
                                            <div class="col-sm-3 col-xs-12">
                                                <select class="form-control"  id="provinces_f" name="provinces_f"></select>
                                            </div>
                                            <div class="col-sm-3 col-xs-12">
                                                 <select class="form-control" id="cities_f" name="cities_f"></select>
                                            </div>
                                            <div class="col-sm-3 col-xs-12">
                                                <select class="form-control" id="areas_f" name="areas_f"></select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-sm-3">街道地址：</label>

                                            <div class="col-sm-9">
                                                <input class="form-control" type="text" name="change_delivery_address.address"
                                                       value="{{change_delivery_address.address}}">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-sm-3">邮政编码：</label>

                                            <div class="col-sm-9">
                                                <input class="form-control" type="text" name="change_delivery_address.postalcode"
                                                       value="{{change_delivery_address.postalcode}}">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-sm-3">手机号码：</label>

                                            <div class="col-sm-9">
                                                <input class="form-control" type="text" name="change_delivery_address.mobile"
                                                       value="{{change_delivery_address.mobile}}">
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-default empty_btn" data-dismiss="modal">取消</button>
                                            <button type="submit" class="btn btn-primary" id="change_btn">确认</button>
                                        </div>
                                        <div style="display:none">
                                            <input type="hidden" class="province" name="change_delivery_address.province_code" value="{{change_delivery_address.get('province_code',110000)}}" id="ycyprovinces_f">
                                            <input type="hidden" class="city" name="change_delivery_address.city_code" value="{{change_delivery_address.get('city_code',110100)}}" id="ycycities_f">
                                            <input type="hidden" class="ycyqb" name="change_delivery_address.area_code" value="{{change_delivery_address.get('area_code',110101)}}" id="ycyareas_f">
                                        </div>
                                    </form>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--添加收货地址开始-->
    </div>
</div>
{% end %}
{% block javascript %}
<!--<script src="{{ static_url('js/validator.min.js') }}"></script>-->
<script src="{{static_url('js/cityselector.min.js')}}"></script>
<script>
    $('#address-edit').addClass('active').parents('.subside').show();
    $("#address-edit").parents('dl').find('.glyphicon').addClass('glyphicon-chevron-down').removeClass('glyphicon-chevron-right');
      $('.delivery_form').bootstrapValidator({
            submitButtons:"#submit_apply",
            verbose: false,
            fields:{
                "add_delivery_address.name": {
                    validators: {
                        notEmpty: {
                            message: '联系人不能为空！'
                        },
                        regexp: {
                            regexp: /^([A-Za-z]|[\u4E00-\u9FA5])+$/,
                            message: '请填写真实姓名！'
                        }
                    }
                },
                provinces:{
                    validators: {
                        notEmpty: {
                            message: '请选择省！'
                        }
                    }
                },
                cities:{
                   validators: {
                        notEmpty: {
                            message: '请选择市！'
                        }
                    }
                },
                areas:{
                    validators: {
                        notEmpty: {
                            message: '请选择区！'
                        }
                    }
                },
                "add_delivery_address.address":{
                    validators: {
                        notEmpty: {
                            message: '请填写完整的街道地址'
                        }
                    }
                },
                "add_delivery_address.mobile":{
                    validators: {
                        notEmpty: {
                            message: '联系人不能为空！'
                        },
                        regexp: {
                            regexp: /^0?(13[0-9]|15[012356789]|18[02356789]|14[57])[0-9]{8}$/,
                            message: '请输入正确的手机号码'
                        }
                    }
                }
            }
        });
      $('.change_address').bootstrapValidator({
          submitButtons:"#change_btn",
          verbose: false,
          fields:{
                "change_delivery_address.name": {
                    validators: {
                        notEmpty: {
                            message: '联系人不能为空！'
                        },
                        regexp: {
                            regexp: /^([A-Za-z]|[\u4E00-\u9FA5])+$/,
                            message: '请填写真实姓名！'
                        }
                    }
                },
                provinces_f:{
                    validators: {
                        notEmpty: {
                            message: '请选择省！'
                        }
                    }
                },
                cities_f:{
                   validators: {
                        notEmpty: {
                            message: '请选择市！'
                        }
                    }
                },
                areas_f:{
                    validators: {
                        notEmpty: {
                            message: '请选择区！'
                        }
                    }
                },
                "change_delivery_address.address":{
                    validators: {
                        notEmpty: {
                            message: '请填写完整的街道地址'
                        }
                    }
                },
                "change_delivery_address.mobile":{
                    validators: {
                        notEmpty: {
                            message: '联系人不能为空！'
                        },
                        regexp: {
                            regexp: /^0?(13[0-9]|15[012356789]|18[02356789]|14[57])[0-9]{8}$/,
                            message: '请输入正确的手机号码'
                        }
                    }
                }
            }

      });
     /*省市区三级联动*/
        cityselector({
            'provinces': 'provinces',
            'cities': 'cities',
            'areas': 'areas',
            'back_provinces': '{{add_delivery_address.province_code}}',
            'back_city': '{{add_delivery_address.city_code}}',
            'back_area': '{{add_delivery_address.area_code}}',
            'ycyprovince': 'ycyprovince',
            'ycycity': 'ycycity',
            'ycyareas': 'ycyareas'
        });
        cityselector({
            'provinces': 'provinces_f',
            'cities': 'cities_f',
            'areas': 'areas_f',
            'back_provinces': '{{change_delivery_address.get("province_code")}}',
            'back_city': '{{change_delivery_address.get("city_code")}}',
            'back_area': '{{change_delivery_address.get("area_code")}}',
            'ycyprovince': 'ycyprovinces_f',
            'ycycity': 'ycycities_f',
            'ycyareas': 'ycyareas_f'
        });
//    删除地址
      $('.delivery_address_delete').on('click', function () {
        if (!confirm('确定要刪除吗？')) {
            return false
        }
        var params = {'_xsrf': $("input[name=_xsrf]").attr('value'), '_method': 'delete', 'address.id': $(this).data('repayment')};
        $.ajax({
            type: "DELETE",
            url: "/delivery_address",
            data: params,
            success: function (data) {
                location.reload(true)
            },
            error: function (data) {
                wModalDialog({
                    content:"删除失败",
                    showAnimate:true,
                    type:"failed"
                 });
                console.log(data);
            }
        });
    });
      $('#change_btn').click(function (){
          var form_validator = $('#form_a').data('bootstrapValidator');

            form_validator.validate();
            if(!form_validator.isValid()){
                return;
            }
      });
//    新增地址 保存
    $('#submit_apply').on('click', function () {
        var form_validator = $('.delivery_form').data('bootstrapValidator');
        form_validator.validate();
        if(!form_validator.isValid()){
            return;
        }
        var $submit_apply = $(this)

        var params = {
            '_xsrf': $("input[name=_xsrf]").val(),
            'delivery_address.name': $("#add_name").val(),
            'delivery_address.address': $("#add_address").val(),
            'delivery_address.mobile': $("#add_mobile").val(),
            'delivery_address.province_code':$('#provinces').val(),
            'delivery_address.city_code':$('#cities').val(),
            'delivery_address.area_code':$('#areas').val()
        };
        console.log(params)
        $.ajax({
            type: "post",
            url: "/delivery_address",
            data: params,
            beforeSend: function (XMLHttpRequest) {
                $submit_apply.addClass("disabled");
            },
            success: function (data, textStatus) {
                wModalDialog({
                    content: ('确认成功!'),
                    showAnimate: true,
                    type: "success",
                    cancelCallBack: function () {
                        location.reload();
                    }
                });
                $('#myModal').modal('hide');
            },
            complete: function (XMLHttpRequest, textStatus) {
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                wModalDialog({
                    content:textStatus + ":" + errorThrown,
                    showAnimate:true,
                    type:"failed"
                 });
            }
        })
    });
    $('.txt_btn').click(function () {

        var address_id = $(this).data('value');
        console.log(address_id);
        $.ajax({
            type: "get",
            url: "/delivery_address",
            data: {'delivery_address_id': address_id},
            success: function (data) {
                var aaa = eval(data).change_delivery_address;
                var $province_code = aaa.province_code;
                var $city_code = aaa.city_code;
                var $area_code = aaa.area_code;
                console.log($province_code,$city_code,$area_code)
                for (var i in aaa) {
                    $('#form_a').find('input[name="' + 'change_delivery_address.' + i + '"]').attr('value', aaa[i]);
                }
                $('#provinces_f').find('option[value="'+$province_code+'"]').attr('selected','selected').change();

                $('#cities_f').find('option[value="'+$city_code+'"]').attr('selected','selected').change();
                $('#areas_f').find('option[value="'+$area_code+'"]').attr('selected','selected').change();
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                wModalDialog({
                    content:textStatus + ":" + errorThrown,
                    showAnimate:true,
                    type:"failed"
                 });
            }


        });
    });

</script>
{% end %}