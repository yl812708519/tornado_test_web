{% extends "../../layouts/application.html" %}
{% autoescape %}
{% block left %}
{% end %}
{% block body %}
<!--版权列表页面  -->
<div class="patent_application" style="margin-top: 0;">
    <div class="container-fluid bg_write_k">
        <div class="row theme_bg">
            {% include "../../layouts/left.html"%}
            <div class="col-md-10 bg_write_k">
                <div class="h_txt_title">
                    <div class="content_title" style="margin: 45px 0 30px 15px;">我的订单</div>
                </div>
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover">
                            {%if len(orders) == 0 %}
                            <div class="col-sm-3 col-sm-offset-4" style="margin-top: 100px;text-align: center;">
                                <p>您还没有订单,快来</p>
                                <p><a href="/mark/service" class="btn btn-danger" style="border-radius: 0;margin-top: 20px;"><span class="glyphicon glyphicon-plus"></span>点击添加</a></p>
                            </div>

                            {% else %}
                            <thead>
                            <tr style="background-color: #edf9ff;border: 1px solid #e1e1e1">
                                <th class="order_list" style="width:15%">订单编号</th>
                                <th class="order_list" style="width: 35%">订单名称</th>
                                <th class="order_list">创建时间</th>
                                <th class="order_list">状态</th>
                                <th class="order_list">费用</th>
                                <th class="order_list">操作</th>
                            </tr>
                            </thead>
                            <tbody>
                                {% for order in orders %}
                                <tr style="border: 1px solid #e1e1e1">
                                    <td class="order_list_td">{{order.id}}</td>
                                    <td class="order_list_td">{{order.name}}</td>
                                    <td class="order_list_td">{{order.created_date}}</td>
                                    <td style="border: none"><div class="{{order.status}}-btn">{{order.status_name}}</div></td>
                                    <td class="order_list_td">{{order.price}}</td>
                                    <td class="order_list_td" style="position: relative;">
                                        <a style="margin-right: 5px;" href="/order/{{order.id}}">查看</a>|
                                        <a style="margin-right: 5px;" name="trash" data-value="{{order.id}}" href="javascript:;">删除</a>
                                        <a style="margin-right: 5px;" name="track" class="track_list" data-value="{{order.id}}" href="javascript:;">进度</a>
                                        <div class="tooltag">
                                         <div class="arrow">
                                             <em></em><span></span>
                                            </div>
                                            <ul class="list">
                                                <li style="text-align: center;"><img src="/s/img/load.gif" alt=""/></li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% end %}
                            {% end %}
                            </tbody>
                        </table>
                        <div class="wtable-footer col-md-12">
                            <div id="pagination-container" class="paging_sty"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!--申请列表-->
        </div>
    </div>
</div>
{% raw xsrf_form_html()%}
{% end %}
{% block javascript %}
<script type="text/javascript" src="{{static_url('js/w-page.min.js')}}"></script>
<script>
    $('#orders').addClass('current');
    /*分页开始*/
    var currentPage = {{current_page}};
    var totalPage = {{total_page}};
    $('#pagination-container').wPage({
        currentPage: currentPage,    // 当前页 默认 1
        totalPage: totalPage,     // 总页数 默认 1
        firstCount: 1,      // 1 ... 3 4 5 ... 108首页处预览页数 默认 1
        lastCount: 1,       // 1 ... 3 4 5 ... 108尾页处预览页数 默认 1
        prevCount: 2,       // 当前页前预览页数 默认 2
        nextCount: 6,       // 当前页后预览页数 默认 6
        clickCallBack: function (pageNum, $element) {
            window.location.href = '/user/orders?currentPage=' + pageNum;
        }
    });
    /*分页结束*/
    $('a[name=trash]').click(function () {
        var order_id = $(this).data('value');
        var $this = $(this);
        wModalDialog({
            content: '您确定删除此条订单吗？',
            showAnimate:false,
            type:"confirm",
            sureCallBack:function (){
                 $.ajax({
                    type: 'post',
                    url: '/order/trash',
                    data: {'order_id': order_id,
                            '_method': 'put',
                            '_xsrf': $('input[name=_xsrf]').val()},
                    dataType: 'json',
                    success: function (response) {
                        if(response.result == 1){
                           /* wModalDialog({
                                content: '已删除',
                                showAnimate:true,
                                type:"success"
                             });*/
                            //  tr删掉。
                            $this.parents('tr').remove()
                        }
                    },
                    error: function (err) {
                        console.log(err)
                    }
                })
            }
        });
    });
//    点击空白处tooltag消失
    hideContent('track_list','tooltag',function(){});

    $('a[name=track]').click(function(){
        var $this = $(this);
        var status_div = $this.next();
        var order_id = $this.data('value');
        status_div.show();
        $('.tooltag').not(status_div).hide();


        $.ajax({
            type: 'get',
            url: '/order/status/' + order_id,
            data: {'order_id': order_id,
                    '_method': 'put',
                    '_xsrf': $('input[name=_xsrf]').val()},
            dataType: 'json',
            success: function (response) {
                var html = '';
                var content = response.list;
                for(var i = 0;i<content.length;i++){
                    var $item = content[i];
                    html += '<li><span>。</span><p>'+$item.remark+'</p><p>'+$item.created_at+'</p></li>'
                }
                status_div.find('.list').html(html);
            },
            error: function (err) {
                console.log(err)
            }
        })
    });

</script>
{% end %}

