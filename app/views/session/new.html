{% extends "layouts/application.html" %}
{% block body %}

   <div class="ban-logo" id="logo">
       <a href="/" ><img src="{{static_url('img/bg_logo.png')}}"/></a>
   </div>
   <div class="warp">
        <form id="login_form" class="form-horizontal sign-wrap" role="form" action="/session" method="post">
            <input type="hidden" value="{{next}}" name="next_url">
            <h3 class="clearfix" style="font-size: 24px">
                <span style="font-size: 14px;color:#ccc;">
                    暂不登录,
                    <a href="/" style="color:#0074BC;font-size: 14px">返回首页</a>
                </span>
                用户登录
            </h3>
            {% raw xsrf_form_html() %}
            <div class="form-group">
                <label class="control-label col-sm-3" style="font-size: 17px">手机号码</label>
                <div class="col-sm-9">
                    <input class="form-control" placeholder="请输入您的手机号码" id="mobile" name="mobile" type="text" value="{{mobile}}" autoFocus>
                </div>
            </div>
            <div class="form-group" id="passwordConclumn">
                <label class="control-label col-sm-3" style="font-size: 17px">密<span style="margin-left: 39px"></span>码</label>
                <div class="col-sm-9">
                    <input class="form-control" placeholder="请输入您的密码" id="password" name="password" type="password"value="{{password}}">
                </div>
            </div>
            <div>
            </div>
            {% if show_captcha %}
            <div class="form-group" id="captchaConclumn">
                <label class="control-label col-sm-3 col-xs-12">验证码</label>
                <div class="col-sm-5 col-xs-6">
                     <input class="form-control" placeholder="验证码" id="captcha" name="captcha" type="text"value="{{captcha}}">
                </div>
            <div class="col-sm-4 col-xs-6">
                    <img id="captcha_code" src="/captcha.jpg?country_code={{country_code}}&account_name={{mobile}}&t={{t}}" style="height: 40px;"/>
                </div>
            </div>
            {% end %}
             {% if globals().get('validation_errors') %}
             {% end %}
             <div class="form-group">
                 <a href="/password/check_code" id="forgot_link" class="pull-right"style="cursor: pointer;margin-right: 15px"/>忘记密码?</a>
             </div>
            <div class="form-group">
                <div class="col-sm-9 col-sm-offset-3">
                     <input type="submit" id="loginBtn" onclick="formCheck()" class="btn btn-blue" value="登录" style="width: 100%;font-size: 20px;"/>
                 </div>
            </div>
             <div id="content" style="display: none;"></div>
        </form>
       <div class="form-horizontal">
           <div class="form-group">
               <div class="col-sm-9 col-sm-offset-3">
                     <a href="/signup{% if next != '/'%}?{{next_url}}{% end %}" class="btn btn-default" style="display: block;font-size: 20px;padding: 8px 12px;">免费创建账户</a>
                </div>
           </div>
       </div>
   </div>
</div>
{% end %}
{% block javascript %}
<script type="text/javascript" src="{{static_url('js/jquery.form.min.js')}}"></script>
<script type="text/javascript" src="{{static_url('js/bootbox.js')}}"></script>
 <script>
     $('#signup_btn').mouseover(function(){
         $(this).css('color','#0074bc');
         $(this).css('border','1px solid #0074bc')
     })
     $('#signup_btn').mouseout(function(){
         $(this).css('color','#686868');
         $(this).css('border','1px solid #CCCCCC')
     })

 </script>
<script>
    {% if show_captcha %}
    $('#captcha_code').click(function() {
        this.src = "/captcha.jpg?country_code="+ $('86').val() +
            "&mobile="+ $('#mobile').val() +"&t=" + new Date().getTime()
    });
    {% end %}
    $('#forgot_link').click(function() {
        var mobile = $('#mobile').val();
        var len = $('#mobile').siblings('small').length;
        if (mobile == '' && len == 0){
            showErr('mobile','请输入手机号！')
            /*$('#mobile').siblings('small').show().parents('.form-group').addClass('has-error')*/
            return false
        }
        if(mobile == '' && len !== 0){
            return false
        }
        $('#login_form').ajaxSubmit({
            dataType: 'json',
            url:'/account/check.json',
            beforeSend: function() {
                $('#forgot_link').addClass('disabled');
            },
            success: function(response) {
                $('#forgot_link').removeClass('disabled');
                var $check_code_form = $('<form action="/password/check_code" method="post">' +
                                                '<input name="mobile" value="'+$('#mobile').val()+'"/>' +
                                                '<input name="next" value="'+$('input[name=next]').val()+'"/>' +
                                                '<input name="country_code" value="'+$('86').val()+'"/>' +
                                                '<input name="_xsrf" value="'+$('input[name=_xsrf]').val()+'"/>' +
                                                '<input type="submit" id="Btn" name="submit" />'+
                                          '</form>');
                $('#content').html($check_code_form);
                $('#Btn').click();
            },
            error: function(response) {
                var err = response.responseJSON;
                if (err.code) {
                    wModalDialog({
                                    content: err.msg,
                                    showAnimate: true,
                                    type: "failed"
                                });
                }
                // 最好可以提示一些发送过于频繁之类的提示
                $('#forgot_link').removeClass('disabled');
            }
        });
        return false;
    });
     function formCheck() {
         $('#login_form').bootstrapValidator({
             verbose: false,
             feedbackIcons: {
                 valid: 'glyphicon glyphicon-ok',
                 invalid: 'glyphicon glyphicon-remove',
                 validating: 'glyphicon glyphicon-refresh'
             },
             fields: {
                 mobile: {
                     validators: {
                         notEmpty: {
                             message: '请输入手机号码'
                         },
                         regexp: {
                             regexp: /^0?(13[0-9]|15[012356789]|17[0-9]|18[02356789]|14[57])[0-9]{8}$/,
                             message: '请输入正确的手机号码'
                         }
                     }
                 },
                 password: {
                     validators: {
                         notEmpty: {
                             message: '密码至少为六位！'
                         },
                         stringLength: {
                             min: 6,
                             message: '密码至少为六位！'
                         }
                     }
                 },
                 captcha: {
                     validators: {
                         notEmpty: {
                             message: '请输入 4 至 4 个字符'
                         },
                         stringLength: {
                             min: 4,
                             max: 4,
                             message: '请输入 4 至 4 个字符'
                         }
                     }
                 }
             }
         });
     }
     {% if globals().get('validation_errors') %}
            {% for field, error in validation_errors.iteritems() %}
            showErr("{{field}}","{{ error }}");
            {% end %}
     {% end %}
</script>
{% end %}