/*! ekinginc 2015-09-11 */
function upload(json){function fileSelected(){for(var a=$fileToUpload.get(0).files,b="",c=0;c<a.length;c++){var d=a[c],e=0;e=d.size>1048576?(Math.round(100*d.size/1048576)/100).toString()+"MB":(Math.round(100*d.size/1024)/100).toString()+"KB",-1!=inames.join("").indexOf(d.name)?chongfu.push(d.name):(b+='<div class="file-item well"><div class="shanchuan"><span class="span2" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:200px;">文件名：'+d.name+'</span><img style="display:none;width:14px;height:16px;" class="oupload" src="'+json.loadingImgUrl+'" /><span class="glyphicon glyphicon-ok-sign" style="display:none;color:#008000;margin-left:5px"></span><span class="glyphicon glyphicon-remove-sign" style="color:red;display:none;margin-left:5px"></span><span class="pull-right" style="display:none"><span class="glyphicon glyphicon-trash" title="删除"/><a class = "down_file glyphicon glyphicon-download-alt" href="###" title="下载" style="margin-left:10px"></a></span><span class="pull-right deleteding" oid='+files.length+'><span class="glyphicon glyphicon-remove"></span></span><br/><span class="span2" style="font-size:12px;color:#6e6e6e;margin-right:20px;">文件大小：'+e+'</span><span class="utime" style="font-size:12px;color:#6e6e6e;margin-right:20px;"></span><span class="uren"  style="font-size:12px;color:#6e6e6e;margin-right:20px;"></span></div></div>',inames.push(d.name),isize.push(d.size),files.push(d))}$fileList.append(b),$(".deleteding").click(function(){files.splice($(this).parent().parent().index()-nums,1),isize.splice($(this).parent().parent().index()-nums,1),inames.splice($(this).parent().parent().index(),1),chongfu.splice($(this).parent().parent().index(),1),$(this).parent().parent().remove(),console.log(inames),console.log(chongfu),files.length<1&&($("#subBtn").get(0).className="btn btn-primary disabled"),cishu++}),chongfu.length>=1&&(wModalDialog({content:"<div>以下文件已添加，请不要重复添加</div>"+chongfu.join("</br>"),showAnimate:!0,type:"alert"}),chongfu.length=0),files.length>=1&&($("#subBtn").get(0).className="btn btn-primary"),$cuowu=$(".glyphicon-remove-sign"),$utime=$(".utime"),$uren=$(".uren"),$pullright=$(".pull-right"),$oupload=$(".oupload"),$chengong=$(".glyphicon-ok-sign")}function uploadFile(){var a=new XMLHttpRequest;a.addEventListener("load",uploadComplete,!1),a.addEventListener("error",uploadFailed,!1),a.addEventListener("abort",uploadCanceled,!1),a.open("POST",json.uploadUrl);var b=new FormData,c=getCookie("_xsrf");b.append("_xsrf",c),b.append("file",files[index]),b.append("file_name",inames[index]),b.append("file_size",isize[index]),b.append("module_name",json.modelName),b.append("entity_id",json.entityId),a.send(b)}function uploadComplete(evt){if(evt.target.status>=200&&evt.target.status<300||304==evt.target.status){var result=eval("("+evt.target.responseText+")");console.log(index+","+nums),1==result.status?($($pullright.get(index+nums)).find(".down_file").attr("href",result.download_url),$chengong.get(index+nums+cishu).style.display="inline-block",$(".oupload:eq(0)").remove(),attachments||($pullright.get(index+nums).style.display="inline-block"),$utime.get(index+nums+cishu).innerHTML="上传时间："+result.upload_time,$uren.get(index+nums+cishu).innerHTML="上传人："+result.operator_name,inum++):($(".oupload:eq(0)").remove(),$cuowu.get(index+nums+cishu).style.display="inline-block",$cuowu.get(index+nums+cishu).innerHTML="请上传10M以下的文件")}else $(".oupload:first").next().next().css("display","inline-block"),$(".oupload:first").next().next().html("网络错误，请重新上传"),$(".oupload:first").remove();return $("#"+json.tipId).html("已上传"+inum+"个"),index===files.length-1?(console.log("全部上传完毕"),index=files.length,void($("#subBtn").get(0).className="btn btn-primary disabled")):(index++,void uploadFile())}function uploadFailed(a){alert("网络错误，请刷新页面重新上传")}function uploadCanceled(a){alert("网络错误，请刷新页面重新上传")}json.showType=json.showType||0,0==json.showType?$("body").append('<div class="modal fade" id="emailModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" ><div class="modal-dialog" style="width:80%" ><div class="container span7 offset3 well" style="width:80%"><form id="uploadForm" class="form-horizontal" enctype="multipart/form-data" method="post" action="javascript:void(0);"><fieldset><legend>文件上传<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button></legend><div class="control-group"><label class="control-label" for="fileToUpload" >选择文件(支持多选,10M以上禁止上传):</label><div class="controls" ><div  class="btn btn-primary" style="width:100px;height:35px;margin-bottom:5px;"><span>添加文件</span><input type="file" name="fileToUpload" id="fileToUpload" multiple="multiple" style="opacity:0;width:80px;position:relative;top:-20px;" ></div></div></div><div class="file-list" id="fileList" style="height:400px;overflow-y:scroll;border-bottom:1px solid #e3e3e3;border-top:1px solid #e3e3e3"></div><div class="form-actions text-left"><button type="button" class="btn btn-primary disabled" id="subBtn" style="margin-top:10px;">立即上传</button><button type="button" class="btn btn-primary pull-right" style="margin-top:10px;" data-dismiss="modal">完成</button></div></fieldset></form></div></div></div>'):$("body").append('<div class="modal fade" id="emailModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" ><div class="modal-dialog" style="width:80%" ><div class="container span7 offset3 well" style="width:80%"><form id="uploadForm" class="form-horizontal" enctype="multipart/form-data" method="post" action="javascript:void(0);"><fieldset><legend>文件上传<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button></legend><div class="file-list" id="fileList" style="height:400px;overflow-y:scroll"></div></fieldset></form></div></div></div>');var attachments=json.attachmentList,$class="#"+json.elementId,$fileList=$("#fileList"),html1="",nums=0,inum=0,inames=[];if(attachments){nums=attachments.length,inum=attachments.length;for(var i=0;i<attachments.length;i++){var filesize1=0;filesize1=attachments[i].file_size>1048576?(Math.round(100*attachments[i].file_size/1048576)/100).toString()+"MB":(Math.round(100*attachments[i].file_size/1024)/100).toString()+"KB",html1+='<div class="file-item well"><div class="shanchuan"><span class="span2" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:200px;">文件名：'+attachments[i].name+'</span><span class="glyphicon glyphicon-ok-sign" style="color:#008000;margin-left:5px"></span><span class="pull-right" ><span class="glyphicon glyphicon-trash"  title="删除" oid="'+attachments[i].id+'"/><a style="margin-left:10px" class = "down_file glyphicon glyphicon-download-alt" href="'+attachments[i].download_url+'" title="下载" ></a></span><br/><span class="span2" style="font-size:12px;color:#6e6e6e;margin-right:20px;">文件大小：'+filesize1+'</span><span class="utime" style="font-size:12px;color:#6e6e6e;margin-right:20px;">上传时间：'+attachments[i].upload_time+'</span><span class="uren"  style="font-size:12px;color:#6e6e6e;margin-right:20px;">上传人：'+attachments[i].operator_name+"</span></div></div>",inames.push(attachments[i].name)}$fileList.append(html1),$("#"+json.tipId).html("已上传"+inum+"个")}$($class).click(function(){$("#emailModal .cus_email").remove(),$("#emailModal").modal("show")});var str=null,chongfu=[],files=[],$uploadForm=$("#uploadForm"),$fileToUpload=$("#fileToUpload"),index=0,isize=[],cishu=0,$shan=$(".glyphicon-trash");$shan.click(function(){var a=$(this),b={};b.id=$(this).attr("oid"),b._xsrf=getCookie("_xsrf"),$.ajax({type:"post",async:!1,url:json.deleteUrl,data:b,beforeSend:function(a){$(".loading").show()},success:function(b,c){1==b.result&&(wModalDialog({content:"删除成功！",showAnimate:!0,type:"alert"}),inames.splice(a.parent().parent().parent().index(),1),chongfu.splice(a.parent().parent().parent().index(),1)),a.parent().parent().parent().remove()},complete:function(a,b){$(".loading").hide()},error:function(){wModalDialog({content:"删除失败！",showAnimate:!0,type:"alert"})}})}),0!=json.showType&&$shan.css("display","none"),$fileToUpload.change(function(){fileSelected()}),$("#subBtn").click(function(){uploadFile(),$(".deleteding").css("display","none"),$(".oupload").css("display","inline-block")})}